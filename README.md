# Servidor de impresion, como servicio. para windows.

Todos los archivos de creacion de exe estan en este Repositorio [https://github.com/cesaredm/printServerExe](https://github.com/cesaredm/printServerExe)

Para este proyecto se esta usando apache common daemon para crear el servicio
Se estan usando las siguientes tecnologias.

- Gson
- EscPos de anastaciocintra
- Apache common daemon
- Procrun - prunsrv.exe para crear el servicio en windows
- InnoSetup
- Launch4j - Creador de wrapper exe a partir del jar
- Amazon Corretto 23.0.2 JDK para desarrollo
- JRE de Adoptium [https://adoptium.net/es/temurin/releases/?os=windows&arch=x64&package=jre&version=23](Link_descarga)
  aunque hay alternativas, en mi caso use esta por mas liviana.

#### JRE-JDK de OpenJdk

- Amazon Corretto
- Zulu
- AdoptOpenJDK (usada actualmente)
- Bellsoft - [https://bell-sw.com/pages/downloads/?version=java-23&os=windows](https://bell-sw.com/pages/downloads/)

### parametros usados

> Creacion del servicio

```cmd
./prunsrv.exe //IS//PrintServer --DisplayName="Servidor de impresion" --Description="Servidor de impresion de cdsfot" --Startup=auto --StartMode=exe --StartImage=E:/direccion_completa_al_exe/PrintServer.exe --StopMode=exe --StopImage=E:/direccion_completa_al_exe/PrintServer.exe --StopParams=stop --ServiceUser=LocalSystem --StartPath=E:/direccion_completa_al_directorio_exe/servidor_impresion/ --LogPath=E:/direccion_completa_al_directorio_exe/servidor_impresion/logs --StdOutput=E:/direccion_completa_al_directorio_exe/servidor_impresion/logs/stdOut.log --StdError=E:/direccion_completa_al_directorio_exe/servidor_impresion/logs/stdErr.log --StopPath=E:/direccion_completa_al_exe/PrintServer.exe
```

En InnoSetup para la creacion del Instalador

```pascal
; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

[Setup]
AppName=PrintServer
AppVersion=1.0
DefaultDirName={pf}\PrintServer
DefaultGroupName=CDsoft
OutputBaseFilename=PrintServerSetup
Compression=lzma
SolidCompression=yes
PrivilegesRequired=admin

[Languages]
Name: "spanish"; MessagesFile: "compiler:Languages\Spanish.isl"

[CustomMessages]
spanish.WelcomeLabel1=¡Bienvenido al instalador de PrintServer un servicio de seridor de impresion.!
spanish.ExitSetupMessage=¿Está seguro de que desea cancelar la instalación de PrintServer?


[Files]
; mi app .exe
Source: "E:\cesar\Documents\servidor_impresion\PrintServer.exe"; DestDir: "{app}"; Flags: ignoreversion
; Amazon Corretto
; Source: "E:\cesar\Documents\servidor_impresion\amazon-corretto-23.0.2x64.msi"; DestDir: "{tmp}"; Flags: ignoreversion deleteafterinstall
; Eclipse JRE
Source: "E:\cesar\Documents\servidor_impresion\OpenJDK23U-jre_x64_23.0.2.msi"; DestDir: "{tmp}"; Flags: ignoreversion deleteafterinstall
; apache common daemon
Source: "E:\cesar\Documents\servidor_impresion\prunsrv.exe"; DestDir: "{app}"; Flags: ignoreversion

[Run]
; Instalar Amazon Corretto en modo silencioso
; Filename: "msiexec.exe"; Parameters: "/i ""{tmp}\amazon-corretto-23.0.2x64.msi"""; Description: Instalando JRE; Flags: waituntilidle
Filename: "msiexec.exe"; Parameters: "/i ""{tmp}\OpenJDK23U-jre_x64_23.0.2.msi"""; Description: Instalando JRE; Flags: waituntilterminated
; Registrar el servicio al finalizar la instalación
;Filename: "{app}\prunsrv.exe"; Parameters: "//IS//PrintServer --Install=""{app}\prunsrv.exe"" --DysplayName=""Servidor de impresion"" --Description=""Servicio de servidor de impresion"" --Startup=auto --Jvm=""{app}\runtime\bin\server\jvm.dll"" --StartMode=exe --StartImage=""{app}\PrintServer.exe"" --StopMode=exe --StopImage=""{app}\PrintServer.exe"" --StopParams=stop --ServiceUser=LocalSystem --StartPath=""{app}\""";
Filename: "{app}\prunsrv.exe"; Parameters: "//IS//PrintServer --DisplayName=""Servidor de Impresión"" --Description=""Servicion de impresion CDsoft"" --Startup=auto --StartMode=exe --StartImage=""{app}\PrintServer.exe"" --StartPath=""{app}"" --StopMode=exe --StopImage=""{app}\PrintServer.exe"" --StopParams=stop --StopPath=""{app}\PrintServer.exe"" --ServiceUser=LocalSystem --LogPath=""{app}\log"" --LogLevel=Debug --StdOutput=""{app}\log\stdOutput.log"" --StdError=""{app}\log\stdError.log"""; WorkingDir: "{app}"; Flags: runhidden
; correr el servicio
Filename: "net"; Parameters: "start PrintServer"; Flags: runhidden
; agrgar regla de firewall para el servidor en el puerto 8088
Filename: "{sys}\netsh.exe"; Parameters: "advfirewall firewall add rule name=PrintServer dir=in action=allow protocol=TCP localport=8088"; Flags: runhidden
Filename: "{sys}\netsh.exe"; Parameters: "advfirewall firewall add rule name=PrintServer dir=out action=allow protocol=TCP localport=8088"; Flags: runhidden

[UninstallRun]
; Detener y eliminar el servicio durante la desinstalación
Filename: "{app}\prunsrv.exe"; Parameters: "//SS//PrintServer"; Flags: runhidden
Filename: "{app}\prunsrv.exe"; Parameters: "//DS//PrintServer"; Flags: runhidden
Filename: "{sys}\netsh.exe"; Parameters: "advfirewall firewall delete rule name=PrintServer"; Flags: runhidden
```

### Explicación de los parámetros usados:

- //IS//PrintServer: Registra el servicio con el nombre "PrintServer".

- --Description: Descipcion del servicio.

- --DisplayName: Nombre del servicio
- --Startup: forma de arranque automatico
- --StartMode: forma de iniciar el servicio en este caso exe, por que tengo un exe, si fuera un jar seria jvm
- --StartImage: Imagen que ejecutara, se le pasa la ruta del exe
- --StopMode: forma de parar el servicio, en este caso exe
- --StopImage: direccion de el exe
- --StopParams: parametros de parar el servicio en este caso stop, que esta en mi clase main
- --ServiceUser: permiso, es este caso como administrador que es LocalSystem
- --StartPath: darle permiso a la carpeta donde nesecita trabajar.
- --LogPath: Direccion donde estaran los logs
- --StdOutput: direccion de LogPath mas el nombre del archivo ejemplo `stdOut.log`
- --StdError: direccion de LogPath mas el nombre del archivo ejemplo `stdErr.log`
- --LogLevel: puede ser `Debug` `Info` `Error`

### Una vez creado el servicio se gestionan de la siguiente forma

- Iniciar servicio

```cmd
net start PrintServer
```

- Detener servicio

```cmd
net stop PrintServer
```

- Eliminar servicio

```cmd
./prunsrv.exe //DS//PrintServer
```

> Esta parte no se usara, pero puede ser usado en el futuro, aunque ahora mismo no funciona.

### jlink

se uso jlink que es una herramiento que viene en el jdk, que sirve para crear un JVM custom con lo necesario que nesecita nuestra app o jar para funcionar.
para saber que dependencias nesecita mi app corro el siguiente comando

```cmd
jdeps --print-module-deps --ignore-missing-deps -recursive PrintServer-1.0-SNAPSHOT-jar-with-dependencies.jar
```

esto devuelve por ejemplo en mi caso

```cmd
java.base
```

entonces solo eso nesecito.

- Para crear el runtime custom corro el siguiente comando

```cmd
jlink --module-path "C:\Program Files\Amazon Corretto\jdk23.0.2_7\jmods" --add-modules java.base --output runtime
```

### configuracion de firewall

esto para que el firewall permita entradas a este puerto del servidor, en caso de ser necesario
se Incluyo en el script de instalacion.

```cmd
netsh advfirewall firewall add rule name="Allow Port 8088" dir=in action=allow protocol=TCP localport=8088
```
# Documentacion de uso

## Archivo de configuracion de impresoras

el servidor trabaja con un archivo de configuracion de impresoras llamadao printers.properties donde se define la configuracion de las impresoras
de la siguiente manera, ocupa los siguientes campos por ahora.

- cocina.ip: que lleva la ip de la impresora en la red
- cocina.port: el puerto de la impresora en este caso el puerto raw normamente siempre es 9100
- cocina.copias: numero de copias que se nesecitan, si no ocupo el valor debe ser 0
- cocina.logo: (Opcional) nombre del logo si se usara uno local, este debe estar ubicado dentro de la carpeta de **impresorasConfig** 
- cocina.papelSize: (Opcional) normalmente es de 48, 32, o 42

```properties
cocina.ip=192.168.1.45
cocina.port=9100
cocina.copias=0
#cocina.logo=logo.png
#cocina.papelSize=48

#aqui mas impresoras
#otra.ip=192.168.1.41
#otro.port=9100
#otro.copias=0
```
## Rutas api
- Imprimir factura
**url:8088/print/{nombre_de_impresora}** : 